---
parent: "XTT - отчеты"
title: "021 Формулы в Excel"
nav_order: 21
permalink: /ru/xtt/excel-formula/
_cus_head: "_popup_head.html"
_cus_index: "021"
---

{% include _xtt_demo.html %}

### Формулы в XTT
Прямое редактирование формул из кода запрещено, тк данный подход чреват ошибками и не очень информативен.\
К тому же внутренне представление формул в Excel xlsx (*абсолютные*) и Excel xml (*относительные*) не позволяет использовать единообразный подход, если бы заполнение формул происходило со стороны ABAP.

Вместо этого, есть несколько (надеюсь простых) правил при редактировании формул в самом **MS Excel**.  

### Копирование данных
Добавление новых строк (и ячеек) происходит за счет копирования исходной строки в шаблоне. Вместе с данными ячеек, границами и прочим форматированием копируются и сами формулы.

Чтобы формулы **"не поехали"** при копировании можно использовать несколько способов:

### Относительные ссылки в XLSX

Самым родным и надежным способом для Excel является - "плясать" от текущей ячейки где прописываем формулу, те использовать *=OFFSET()* (в русской локализации *=СМЕЩ()*) в купе с =INDIRECT() / ДВССЫЛ() для создания *относительных* формул.

те, чтобы получить сумму предыдущих трех ячеек (1,2,3), надо сместиться на -3 ячейки по столбцам и расширить диапазон на 3 ячейки

![image](https://user-images.githubusercontent.com/36256417/91626264-4eeedb00-e9cf-11ea-878f-ffca4d5ed260.png)

Смещение можно указать и напрямую в INDIRECT("RC[**-3**]",0), в таких формулах также может пригодится:
  * *=ROW() / СТРОКА()* и
  * *=COLUMN() | СТОЛБЕЦ()* 

которые без передачи аргументов возвращают текущую строку и столбец 

### Знак $ для строки
Указывать смещения от текущей ячейки, не очень удобно, поэтому для упрощения было введена правило:

Если указать номер **текущей** строки со знаком **$**, он будет заменен во время выполнения 

![image](https://user-images.githubusercontent.com/36256417/91650284-5b426900-ea9f-11ea-92ea-4563a952efc1.png)

В итоговом отчете будет так

![image](https://user-images.githubusercontent.com/36256417/91650345-339fd080-eaa0-11ea-9d36-214d2627da32.png)

PS: Для [;direction=column](../output-direction/) (те вывода таблицы по столбцам) данное правило соответственно будет работать для формул в таком виде **$E**

### Shared formulas

Ранее в **AOK & XTT** происходили "таинственные" исчезновения формул\
Происходил данный баг когда относительная ссылка встречалась несколько раз подряд

В текущей версии преобразование из абсолютной ссылки в относительную и обратно, надеюсь, происходит без проблем 
![image](https://user-images.githubusercontent.com/36256417/91650747-2df8b980-eaa5-11ea-8da9-313a1eb31f78.png)

***

### Именованные диапазоны ячеек 

Если сослать на именованный диапазон, который будет изменен во время выполнения

* Произойдет однократное растягивание всего диапазона

![image](https://user-images.githubusercontent.com/36256417/91657698-cb271280-eae4-11ea-9216-bb44215fddb0.png)

* Если же название диапазона заканчивается на '_' данный будет размножен и итоговый список будет заменен в самой формуле 

![image](https://user-images.githubusercontent.com/36256417/91702501-a7260880-eb9a-11ea-9e20-5d468d640e51.png)


### Сумма дочерних элементов
Для суммы дочерних вовсе не обязательно использовать предыдущий способ с именованными ячейками или создавать [иерархии](../tree-group-by-fields/)

Если нужно просуммировать поле таблицы можно воспользоваться стандартными средствами Excel

![image](https://user-images.githubusercontent.com/36256417/91716839-2e32ab00-ebb2-11ea-961e-c12ae27ce2c6.png)

### Word & PDF
Но что если нужно просуммировать значения поля не только в Excel, но и в Word или Pdf?
В этом случае можно воспользоваться функциями агрегации [;func= SUM | AVG | COUNT | FIRST](../tree-aggregation-functions/)

### Формулы с условным форматированием
Для формул в условных форматированиях, желательно указывать область действия в виде целых столбцов

![image](https://user-images.githubusercontent.com/36256417/91657657-8307f000-eae4-11ea-941b-a4dc1dd409ef.png)
